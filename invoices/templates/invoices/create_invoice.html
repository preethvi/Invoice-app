{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-5 p-4 shadow-lg rounded-4 bg-white" style="max-width: 900px; perspective: 1500px;">

  <h2 class="mb-5 text-primary fw-bold text-center">Create Invoice</h2>

  <form method="post" novalidate id="invoice-form">
    {% csrf_token %}

    <div class="row mb-4 g-3">
      {% for field in invoice_form %}
      <div class="col-md-6">
        <label for="{{ field.id_for_label }}" class="form-label fw-semibold">{{ field.label }}</label>
        {{ field|add_class:"form-control" }}
        {% if field.help_text %}
          <small class="form-text text-muted">{{ field.help_text }}</small>
        {% endif %}
        {% for error in field.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      {% endfor %}
    </div>

    <h4 class="text-secondary fw-semibold mb-3 d-flex justify-content-between align-items-center">
      Invoice Items
      <button type="button" id="add-item-btn" class="btn btn-success btn-sm">
        <i class="bi bi-plus-lg"></i> Add Item
      </button>
    </h4>

    {{ formset.management_form }}

    <table class="table table-bordered rounded shadow align-middle text-center" id="invoice-items-table">
      <thead class="table-dark text-white">
        <tr>
          <th style="width:45%;">Product</th>
          <th style="width:15%;">Quantity</th>
          <th style="width:15%;">Price</th>
          <th style="width:15%;">Remove</th>
        </tr>
      </thead>
      <tbody>
        {% for form in formset %}
        <tr class="invoice-item-row">
          <td>{{ form.product|add_class:"form-select w-100" }}</td>
          <td>{{ form.quantity|add_class:"form-control text-center" }}</td>
          <td>{{ form.price|add_class:"form-control text-center" }}</td>
          <td class="text-center align-middle">
            <button type="button" class="btn btn-danger btn-sm remove-item-btn">
              <i class="bi bi-trash3"></i>
            </button>
            {{ form.DELETE }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="submit" class="btn btn-gradient-green btn-lg w-100 mt-4 shadow">Submit Invoice</button>
  </form>

  <a href="{% url 'add_product' %}" class="btn btn-outline-secondary btn-lg mt-4 w-100 shadow-sm text-center">
    <i class="bi bi-plus-circle me-2"></i> Add New Product
  </a>
</div>

<!-- JavaScript for dynamic formset: add and remove rows -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const addBtn = document.getElementById('add-item-btn');
    const tableBody = document.querySelector('#invoice-items-table tbody');
    const totalFormsInput = document.querySelector('#id_form-TOTAL_FORMS');

    addBtn.addEventListener('click', function () {
      const totalForms = parseInt(totalFormsInput.value);
      const newFormIdx = totalForms;

      // Get empty template row from the first row cloned and cleaned
      let newRow = document.querySelector('.invoice-item-row').cloneNode(true);
      newRow.querySelectorAll('input, select').forEach(function (input) {
        const name = input.name.replace(/form-\d+-/, `form-${newFormIdx}-`);
        const id = input.id.replace(/form-\d+-/, `form-${newFormIdx}-`);
        input.name = name;
        input.id = id;

        if (input.type === 'checkbox') {
          input.checked = false;
        } else {
          input.value = '';
        }
      });
      // Clear DELETE checkbox or button
      newRow.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

      tableBody.appendChild(newRow);

      totalFormsInput.value = newFormIdx + 1;

      newRow.querySelector('.remove-item-btn').addEventListener('click', function () {
        newRow.remove();
        updateTotalForms();
      });
    });

    // Remove row functionality for existing rows
    document.querySelectorAll('.remove-item-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const row = this.closest('tr');
        // If row corresponds to an existing instance, mark DELETE checkbox
        const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="DELETE"]');
        if (deleteCheckbox) {
          // Mark checkbox checked and hide row to allow removal on form submit
          deleteCheckbox.checked = true;
          row.style.display = 'none';
        } else {
          row.remove();
          updateTotalForms();
        }
      });
    });

    function updateTotalForms() {
      const forms = document.querySelectorAll('.invoice-item-row:not([style*="display: none"])');
      totalFormsInput.value = forms.length;
    }
  });
</script>
{% endblock %}
